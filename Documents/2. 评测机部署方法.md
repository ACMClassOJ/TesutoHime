# 评测机部署方法

by cong258258

0. 注意事项：**不建议评测机与Web服务器在同一运行环境中。**部署时评测机只需与Web通信，无需公网访问。

2. 安装必备环境，终端输入

    ```
    sudo apt install -y libseccomp-dev libseccomp2 seccomp protobuf-compiler libnl-3-dev libnl-route-3-dev valgrind iverilog python3 python3-pip build-essential make cmake git wget curl make cmake
    ```

3. 获取项目源代码，或将服务器ssh公钥加入github ssh key 或 deploy key后输入
    ```
    git clone git@github.com:ACMClassOJ/TesutoHime.git
    ```

4. 安装python运行库，输入

   ```
   sudo pip3 install flask
   ```

5. 创建工作目录，复制所需文件，输入（路径不可更改）
   ```
   sudo mkdir /exe/ && sudo chmod 777 /exe/
   sudo mkdir /work/ && sudo chmod 777 /work/
   sudo cp TesutoHime/nsjail /bin
   sudo chmod 0755 /bin/nsjail
   ```

6. 创建评测机数据缓存目录，（路径可自定义） 下文称该路径为``judger_cache_dir``
   
   ```
   mkdir /home/rbq/TesutoHime_data_cache
   ```
   
6. 编写评测机配置文件，输入

   ```
   cd TesutoHime/Judger
   cp config-sample.py config.py
   ```
   使用编辑器打开config.py，填写对应参数
   ```python
   class DataConfig:
        server = 'http://192.168.1.233:8080/'   #data_service_url，数据服务地址，可以是内网
                                                #一定要有http://
        key = 'data_service_key'                #data_service_key，数据服务密钥
        cache_dir = '/home/rbq/TesutoHime_data_cache' #judger_cache_dir，数据会被缓存本地的哪个文件夹
   
    Path = '/work'
    My_Web_Server_Secret = "judger_secret"      #judger_secret，web向judger请求通信时给出的密钥
                                                #需告知web，每台评测机不可重复，建议生成随机字符串构成一个较强的密钥     
    Master_Server_Secret = "judger_secret"      #web_secret，与web服务器通信用密钥，由web给出
    busyFlag = '/work/busyFlag'                 
    Web_Server = "http://192.168.1.233:5000/OnlineJudge/api"
                                                #web_url，web服务器url/api，可以是内网，一定要有http://
    Heart_Beat_Period = 3000                    #judger向web发送心跳包间隔，单位ms，生产环境建议半分钟以上减小网络压力
    API_port = 8000                             #judger_port，judger与web通信时judger所用端口
    Judge_Result_Resend_Period = 1000
    Performance_Rate = 1                        # real_run_time/oj_standard_time，用于平衡不同机器之间运行速度差距
   ```

8. 测试judger是否可以运行，输入

   ```
   sudo python3 TesutoHime/Judger/run.py
   ```

8. 在浏览器中访问 ``http://judger_url:judger_port/``查看是否看到``This is API.``字样。
