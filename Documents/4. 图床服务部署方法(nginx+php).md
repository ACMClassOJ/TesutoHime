# 3. 图床服务部署方法(以nginx+php为例)

by cong258258

0. 注意事项：图床服务需要可从公网访问（测试环境除外）。图床服务可与Web部署在同一服务器上。

2. 安装必备环境，终端输入

   ```
   sudo apt install -y nginx php php-fpm
   ```

3. 获取项目源代码，或将服务器ssh公钥加入github ssh key 或 deploy key后输入

   ```
   git clone git@github.com:ACMClassOJ/TesutoHime.git
   ```

4. 创建数据服务在本机的存储目录，（路径可自定义） 下文称此路径为``pic_service_dir``。

   ```
   mkdir /home/rbq/TesutoHime_pic
   ```
   
8. 选取数据服务密钥，建议生成随机字符串构成一个较强的密钥。下文称此密钥为``pic_service_key``。

   ```
   mkdir /home/rbq/TesutoHime_pic/pic_service_key
   ```
   
5. 将PicService的php模版复制到``pic_service_dir/pic_service_key``：

   ```
   cp TesutoHime/PicService/upload_template.php /home/rbq/TesutoHime_pic/pic_service_key/upload.php
   ```

   使用编辑器打开``upload.php``，填写对应参数

   ```php
   <?php
   $dir = 'data_directory';       //即pic_service_dir/，不带key，注意末尾斜杠
   ...
   ?>
   ```

6. 给予pic_service_dir php用户组读取权限：

   ```
   sudo chown -R www-data:www-data /home/rbq/TesutoHime_pic/
   ```
   
7. （nginx+php详细配置请百度）修改nginx配置文件，用超级用户权限打开``/etc/nginx/nginx.conf``，在http中添加如下参数：（可根据自己配置习惯进行修改）

   ```nginx
   server {
       listen       8090;            #pic_service_port
       server_name  localhost;       #如果使用域名请在此填写
   
       location / {
           root  /home/rbq/TesutoHime_pic/;   #pic_service_dir，不带key
           index  index.html;
       }
   
       error_page   500 502 503 504  /50x.html;
       location = /50x.html {
       	root   html;
       }
   
       location ~ \.php$ {
       root           /home/rbq/TesutoHime_pic/;       #pic_service_dir，不带key
       fastcgi_pass   unix:/run/php/php7.4-fpm.sock;   #请确认php-fpm版本
       fastcgi_index  index.php;
       fastcgi_param  SCRIPT_FILENAME  $document_root$fastcgi_script_name;
       include        fastcgi_params;
       }
       client_max_body_size    10000m;                 #文件上传大小限制
   }
   ```

8. 重启php与nginx

   ```
   sudo systemctl restart php7.4-fpm
   sudo systemctl restart nginx
   ```

9. 在浏览器中访问 ``http://pic_service_url:pic_service_port/pic_service_key/upload.php``查看是否看到``-501``字样。

10. 在任意一台linux bash中输入如下命令：

   ```
   curl http://pic_service_url:pic_service_port/pic_service_key/upload.php -F "file=@test.jpg"
   ```

   其中file=@后接要上传的图片，查看返回字样是否为``0``并检查该文件是否在``data_service_dir/``下。（**此处为图床服务与数据服务最大的不同，文件位置并不在key目录下，这保证了图片可以在不知道图床服务密钥的情况下仍可以被访问**）

   

   

