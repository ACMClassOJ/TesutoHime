{% extends 'base.html' %}

{% set page='Detail' %}

{% block head %}
    <link rel="stylesheet" href="{{ url_for('.static', filename = 'lib/font-awesome/css/all.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('.static', filename = 'lib/github.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('.static', filename = 'dark.css') }}">
    <link rel="stylesheet" href="{{ url_for('.static', filename = 'countdown_svg.css') }}">
{% endblock %}

{% block content %}
    <div class="card card-body">
        <h1 class="text-center">评测详情 {{ submission.id }}</h1>
        <div class="table-responsive">
            <table class="table table-striped table-bordered" id="status_list">
                <thead>
                <tr>
                    <th>评测编号</th>
                    <th>用户昵称{% if is_Admin -%}<span class="small">（点击查看用户名）</span>{%- endif %}</th>
                    <th>题目名称</th>
                    <th>评测状态</th>
                    {% if details != None -%}
                        {% if details.resource_usage != None -%}
                            <th>运行时间</th>
                            <th>内存</th>
                        {%- endif %}
                    {%- endif %}
                    {%- if show_score %}
                        <th>分数</th>
                    {%- endif %}
                    <th>语言</th>
                    <th>提交时间</th>
                </tr>
                </thead>
                <tr>
                    <td>{{ submission.id }}</td>
                    <td>
                        {% if is_Admin -%}
                        <span data-container="body" data-toggle="popover" data-placement="left" data-content="用户名：{{ submission.username }}">{{ submission.user.friendly_name }}</span>
                        {% else -%}
                        <span>{{ submission.user.friendly_name }}</span>
                        {%- endif %}
                    </td>
                    <td>
                        <a href="/OnlineJudge/problem?problem_id={{ submission.problem_id }}">{{ submission.problem_id }}. {{ submission.problem.title }}</a>
                    </td>
                    <td>
                        <b>
                            <span class="text-{{ judge_status_info[submission.status.name].color }}">
                                {{ judge_status_info[submission.status.name].name }}
                            </span>
                        </b>
                    </td>
                    {% if details != None -%}
                        {% if details.resource_usage != None -%}
                            <td>{{ details.resource_usage.time_msecs }} ms</td>
                            <td>{{ "%.2f" % (details.resource_usage.memory_bytes / 1024) }} KiB</td>
                        {%- endif %}
                    {%- endif %}
                    {%- if show_score %}
                        <td>{{ submission.score }}</td>
                    {%- endif %}
                    <td>{{ language }}</td>
                    <td>{{ submission.created.strftime('%b-%d-%Y %H:%M:%S') }}</td>
                </tr>
            </table>
        </div>
        {% if details != None -%}
        <div class="row">
            <div class="m-auto">
                {% for group in details.groups %}
                    {% for j in range(group.testpoints|length) -%}
                        <a
                            href="#{{ group.id }}_{{ j }}"
                            class="badge badge-pill badge-{{judge_status_info[group.testpoints[j].result].badge_type}}"
                        >
                            {{ judge_status_info[group.testpoints[j].result].abbrev }}
                        </a>
                    {%- endfor %}
                {%- endfor %}
            </div>
        </div>
        {%- endif %}
        {% if False and (Detail['Status'] == '0' or Detail['Status'] == '1') -%}
        <div class="row">
            <div class="m-auto">
                <div id="judge_detail_auto_refresh_svgcontainer">
                    <svg width="66" height="66" VIEWBOX="0 0 66 66">
                        <circle cx="33" cy="33" r="15" stroke-width="2" stroke="#d1d3d7" fill="none"></circle>
                        <circle id="judge_detail_auto_refresh_circle" cx="33" cy="33" r="15" stroke-width="6" stroke="#e77c8e" fill="none" transform="matrix(0,-1,1,0,0,66)" stroke-dasharray="100,0"></circle>
                    </svg>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="m-auto">
                <p>auto refresh in <span id="judge_detail_auto_refresh_timeleft">?</span> second(s)</p>
            </div>
        </div>
        {%- endif %}
        <hr>
        <div>
            <span class="h6"> 代码： </span>
            {% if submission.public == True -%}
            <span class="badge badge-success"> 公开代码 </span>
            {% else -%}
            <span class="badge badge-secondary"> 私有代码 </span>
            {%- endif %}    
            </span>
            <span class="float-right">
                {% if abortable -%}
                <form action="abort" method="POST" style="display: inline">
                    <button class="btn btn-secondary btn-sm">终止评测</button>
                </form>
                {%- endif %}
                <button id="copy_button" class="btn btn-primary btn-sm" data-clipboard-target="#judge_detail_code_highlighted">复制</button>
            </span>
        </div>
        <pre class="cpp"><code id="judge_detail_code_highlighted">Waiting for code</code></pre>
        {% if submission.message != None and submission.message != '' -%}
        <pre><code>{{ submission.message }}</code></pre>
        {% endif -%}
        {% if details != None -%}
            <hr>
            <div>
                {% if details.message != None and details.message != '' -%}
                <pre><code>{{ details.message }}</code></pre>
                {% endif -%}
                {% if details.groups|length > 0 -%}
                <h5>测试点详情：</h5>
                <div class="table-responsive">
                    {% for group in details.groups %}
                        <table class="table table-striped table-bordered">
                            <thead>
                            <tr>
                                <th>
                                    <span>Subtask {{ group.id }}: {{ group.name }}</span>
                                    <span class="ml-2">Score: {{ group.score }}</span>
                                </th>
                            <tr>
                            </thead>
                            {% for j, testpoint in enumerate(group.testpoints) -%}
                                <tr>
                                    <td>
                                        <div class="row">
                                            <div class="col-4">
                                                Testpoint {{ testpoint.id }}: 
                                                <b><span class="text-{{judge_status_info[testpoint.result].color}}" id="{{ group.id }}_{{ j }}">
                                                    {{ judge_status_info[testpoint.result].name }}
                                                </span></b>
                                            </div>
                                            {% if testpoint.resource_usage != None -%}
                                            <div class="col-2"> <i class="fa fa-clock"></i> {{ testpoint.resource_usage.time_msecs }} ms </div>
                                            <div class="col-2"> <i class="fa fa-memory"></i> {{ "%.2f" % (testpoint.resource_usage.memory_bytes / 1024) }} KiB </div>
                                            {% if testpoint.resource_usage.file_size_bytes > 0 -%}
                                            <div class="col-2"> <i class="fa fa-database"></i> {{ "%.2f" | format(testpoint.resource_usage.file_size_bytes / 1048576) }} MiB </div>
                                            {%- endif %}
                                            {%- endif %}
                                        </div>
                                        {% if testpoint.message != '' -%}
                                        <pre style="white-space: pre-wrap; word-wrap: break-word;">{{ testpoint.message }}</pre>
                                        {%- endif %}
                                    </td>
                                </tr>
                            {%- endfor %}
                        </table>
                    {%- endfor %}
                </div>
                {%- endif %}
            </div>
        {%- endif %}
    </div>
{% endblock %}

{% block script %}
    <script src="{{ url_for('.static', filename = 'lib/clipboard.min.js') }}"></script>
    <script>
        var clipboard = new ClipboardJS(document.getElementById('copy_button'));
        $(function(){
            $("[data-toggle='popover']").popover();
        });
        $("[data-toggle='popover']").click(function(){
            setTimeout(function(){
                $("[data-toggle='popover']").popover('hide')
            }, 2000);
        });
    </script>
    <script src="{{ url_for('.static', filename = 'lib/highlight.min.js') }}"></script>
    <script>
        $(function () {
            $.ajax({
                type: "GET",
                dataType: "text",
                url: "{{ code_url | safe }}",
                success: function (response_text) {
                    $("#judge_detail_code_highlighted").text(response_text);
                    hljs.initHighlighting();
                },
            });
        });

        {% if False -%}
        $(function () {
            var count_down_time = 3;
            if({{ Detail['Status'] }} == '0' || {{ Detail['Status'] }} == '1')
            {
                var r = 15;
                var origin_interval = 15;
                var interval = origin_interval;
                setInterval(function() {
                    interval--;
                    var percent = interval / origin_interval;
                    var perimeter = 2 * Math.PI * r;
                    $("#judge_detail_auto_refresh_circle").attr('stroke-dasharray', perimeter * percent + ',' + perimeter * (1 - percent));
                    $("#judge_detail_auto_refresh_timeleft").html(parseInt(count_down_time * interval / origin_interval))
                    if(interval == 0)
                        window.location.reload();
                }, count_down_time * 1000 / origin_interval); 
            }
        });
        {%- endif %}
    </script>
{% endblock %}
